# 무중단 배포 전략

얼마전 기술 면접에서 Jenkins를 써봤는데 배포 방식 어떤걸 다뤄봤냐는 질문이 있었다. 기존에 Jenkins를 구축하고 경험하면서 관리하고 개발하던 애플리케이션은 무중단 배포를 했던 적이 없어서 이런 부분을 고려해본적이 없었다. 

카나리 방식은 아는지, 블루 그린 배포 방식은 아는지, 롤링 방식을 썼던건지 여쭤보시는데, 무중단 배포를 한적이 없다보니 단어 자체가 생소했고 카나리 전략은 광산에 카나리가 있는데 어쩌고 저쩌고 그냥 썰만 들어봤지 이 배포 방식에 대해서 직접 경험하고 다뤄본적이 없었다.

앞으로 경험하고 싶은 도메인은 전자상거래 도메인이고 무중단으로 배포해야하는 경우가 비일비재할텐데, 모르고 있으면 안될 것 같아서 이 내용을 한번 정리해볼까한다.

# 왜 무중단 배포가 필요할까?

개인 적인 생각이건데..

실시간으로 사용자가 서비스를 이용하는 애플리케이션의 경우에는 사용자가 서비스를 사용하는데 혹은 결제하는데 갑자기 배포 때문에 중단되면 정말 큰일이 날 것이다. 배포를 한다 할지라도 서비스는 중단되어서는 안되고, 사용자는 배포가 되었는지도 모르게 자연스럽게 서비스를 사용해야할 것이다.

하지만, 기능에 문제가 있거나, 새로운 기능을 추가하기 위해서는 반드시 배포를 해야한다. 그러면 사용자가 배포가 되었는지도 모르게 새로운 기능을 추가하거나 문제 있는 기능을 고쳐 배포하려면 어떻게해야할까?

그때 언급되는 개념이 바로 무중단 배포이다.

이 무중단 배포는 배포 중에 서비스가 멈추지 않고, 실제 사용자가 정상적으로 서비스를 사용할 수 있도록 도와준다.

# 무중단 배포는 어떻게 할 수 있을까?

먼저 인프라적 관점으로 생각해본다면, 새로운 기능을 추가하거나 버그 픽스를 실제 서비스에 반영하기 위해서는 반드시 배포를 해야하고, 배포하기 위해서는 서비스 재시작이 필요할 것이다. 그러면 반드시 서비스가 재시작 될 것인데 어떻게 무중단이냐. 그에는 무중단 배포를 위한 전제 조건을 보면 알 수 있다.

무중단 배포를 위해서는 반드시 서버는 2대 이상 존재해야하고, 이 서버 구성은 로드밸런서로 구성되어야 한다. 왜 그럴까?

그 이유는 서버 1대가 죽더라도 또다른 서버 1대는 계속적으로 서비스를 운영하면서 서비스가 죽지 않도록 해야하기 때문이다. 그러니깐, 서버 1대가 업데이트 작업을 수행하고 있으면 또다른 서버가 서비스를 운영하고 있으면 된다. 만약 단일 서버로 운영한다면 다운타임이 반드시 존재하기 때문에 무중단이 될 수가 없다.

무중단 배포는 결국 2대 이상의 서버 그리고 로드밸런서가 필요하다.

# 무중단 배포 방법에는 어떤 것들이 있을까?

## 롤링 배포

롤링 배포는 여러대의 서비스를 운영하고있는 서버들을 하나씩 차례로 배포하는 방식이다.

![Untitled](무중단%20배포%20전략/Untitled.png)

위의 그림처럼 총 5대가 운영중이고 서버 1번부터 차례로 배포를 진행하면, 배포가 진행되는 동안에는 2, 3, 4, 5 서버가 서비스를 운영하고 있을 것이다. 1번이 끝나고 2번 그리고 3.. 5번까지 업데이트를 차례로 진행하면, 서비스는 계속 운영중인 상태로 총 4대가 계속 살아있는 그림이 될 것이다.

그런데 이 롤링 배포는 조금 문제가 있어보인다. 서버 1이 업데이트가 완료되었고 서버 2가 배포를 하고있다.

![Untitled](무중단%20배포%20전략/Untitled%201.png)

그런데 이번 업데이트는 새로운 초특가 할인 이벤트를 진행하기 위해서 진행된 업데이트이다. 로드밸런서에 의해 사용자의 트래픽이 분산되는데 서버 1, 3, 4, 5 중 오로지 서버 1번만 이벤트 페이지가 활성화 되어있다. 그러면 사용자들 중 서버1번에 운좋게 연결이 닿은 사용자만 이벤트에 참여할 수 있지 않을까?

바로 롤링 배포는 이러한 단점을 가지고 있다. 업데이트된 버전과 업데이트 이전 버전의 상이함으로 인해, 호환성의 문제가 발생할 수 있다.

또한, 배포를 하면 반드시 한대 이상은 다운타임이 존재하기 때문에 서버의 가용성도 떨어진다.

## 블루-그린 배포

여기서 블루와 그린은 기존 버전과 신버전을 의미한다. 이 블루-그린 배포는 기존 버전에 연결되어 있던 트래픽을 일괄적으로 신 버전으로 전환하는 배포 방식이다. 그니깐 총 3대로 서비스를 운영하고 있다면, 블루에 해당하는 기존버전을 계속 운영하다가 새로운 버전 업데이트가 필요하면 추가로 3대에 신 버전을 배포하고, 이 3대에 배포가 끝나면 새로운 버전의 서버로 트래픽을 한꺼번에 전환하는 방식이다.

![Untitled](무중단%20배포%20전략/Untitled%202.png)

## 카나리 배포

카나리 배포는 어딜가도 유래는 꼭 설명하는 것 같다. 그럼 나도한번… 

카나리 배포로 이름이 지어진 이유는 카나리아 라는 새에서 이름으 따와서 그렇다. 이 카나리아라는 새는 유독가스에 굉장히 민감해서, 과거 석탄 광산에서 유독가스의 누출 위험을 위해 이 카나리아라는 새를 광산에 함께 데리고 들어갔다고 한다. 카나리아가 픽하고 쓰러지면, 유독가스가 있다는 것을 인지하고 광부들이 유독가스에 노출되지 않도록 했었다고 한다.

그러면 왜 카나리 배포인가. 서버가 픽하고 쓰러져버리는 것인가?

그런 것은 아니고, 새로운 버전을 서비스 운영 서버에 배포할 때, 모든 사용자에게 배포하는 게 아니라, 일부 사용자에게만 배포해보면서 문제가 있는지를 보고 문제가 없으면 점진적으로 배포해서 문제가 되었을 때, 일부만 문제되어 손해를 줄이기 위한 방법이다.

아하.. 서버는 사람과 카나리아를 의미하고, 카나리아가 먼저 픽하고 쓰러져버리면 아 안되겠구나 미리 사람이 인지할 수 있으니깐 그렇게 지어진거구나?

그니깐, 일부만 배포해서 운영해보는데 그 배포된 서버가 문제를 일으켜(카나리아가 픽하고 쓰러져) 그러면 나머지 서버에는 아.. 이거 배포하면 안되겠다.하는거야!! 그래서 카나리 배포인가보다.

![Untitled](무중단%20배포%20전략/Untitled%203.png)

그래서 문제가 없으면 또 일부 배포해보고, 점진적으로 배포해서 최종적으로 모두 배포하는 배포 전략이 되겠다.