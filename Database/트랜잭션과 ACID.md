# 트랜잭션과 ACID

트랜잭션의 사전적 의미를 찾아보면 `처리` 라는 뜻을 가진다는 것을 알 수 있다. 처리는 그러면 어떤 의미의 처리일까? 

## 실생활의 트랜잭션

만약 우리가 과일가게에서 사과를 3개를 산다고 생각해보자. 사과 3개를 사기 위해, 수많은 과일 중에 원하는 사과를 보고 그 사과중에 제일 맛있어보이는 사과 3개를 고른다.

과일가게 주인 아저씨에게 이 사과 얼마에요? 라고 묻는다.

가격을 듣고 내가 가진 돈이 맞으면 살 수도, 그렇지 못할 수도 있다. 어쩌면 3개가 아닌 2개밖에 못살 수도 있다.

만약 살 수 있었다면, 돈을 지불하고 비닐봉지에 담긴 사과 3개를 가지고 갈 것이다.

그리고 상인은 사과 3개만큼의 값만큼 매출을 올렸을 것이다.

나는 이 사과 3개를 사기 위한 처리를 수행한 것이다.

우리는 사과 3개를 사기 위해, 단순히 구매만 한 것이 아니라, 구매를 하기 위해 여러 과일 중에 사과를 선택했고, 그 사과 중에서도 제일 맛이 있어보이는 사과로 선택도 했고, 돈이 맞는지도 확인하며 과일을 끝내 구매하였다.

이처럼 특정 행위를 위해 처리하는 작업은 단순히 한개로만 이루어지지 않고 많은 작업들이 이루어졌다. 물론 한개의 작업만수행할 수도 있다.

자 그러면 데이터베이스에서 말하는 트랜잭션은 어떨까? 위에서 본 바와 같이 `여러 행위들을 묶는 논리적인 작업 들` 이라고 추상적으로 말을 할 수 있을 것 같다.

## 데이터베이스 트랜잭션

위의 예시를 가지고 데이터베이스 트랜잭션을 추가로 설명해보자.

어쨌든 구매를 했다. 그런데 구매를 하게되면 내입장에서는 돈을 지불하고, 사과를 얻은거지만 판매자 입장에서 보면 사과를 주고 돈을 받은 것이기 때문에, 서로 간의 밀접한 연관관계가 있다.

돈을 지불하는 순간! 판매자는 돈을 받아야한다.

그래서 트랜잭션의 예시로 제일많이 드는 것이 계좌 송금 예시이다.

보통 입금을 하면 누군가의 돈은 줄고 입금 받는 대상은 돈이 늘어나야한다. 이렇게 총 두 과정이 하나의 트랜잭션인 셈이다. 만약에 트랜잭션이 없었더라면, 누군가 입금을했다. 근데 은행 시스템에 오류가 발생했다. 그다음 입금 받을 대상에 입금을 해줘야하는데, 시스템이 재부팅되면서 그일을 까먹어버렸다. 그러면 돈이 사라지게된다. 그런 상황이 절대로 나오면 안된다.

## 트랜잭션의 특징

이 트랜잭션은 여러 상황들의 문제점을 고려하여 이 트랜잭션이 갖는 특징을 총 4가지로 분류하였다.

그 개념이 바로 우리가 흔히 알고 있는 `ACID` 이다.

이 트랜잭션의 특징을 그냥 외우기보다는 한번 이해를 해보자. 특징이라고하지만 너무 당연한 것들이다.

트랜잭션 일반적으로 4가지로 분류하여 각각의 원자성, 일관성, 격리성, 지속성을 말한다.

### 원자성(Atomicity)

원자라는건 더이상 쪼갤 수 없는 하나 정도로 이해하면된다. 더이상 쪼갤 수 없는 단위로 트랜잭션을 보겠다는 의미이다. 그러니깐 이 트랜잭션은 여러개의 질의가 포함되어있다할지라도 오로지 한묶음으로 보겠다는 것이다. 어떤 질의는 되고 어떤 질의는 안되는 그런 상황은 없다는 것이다.

![Untitled](트랜잭션과%20ACID/Untitled.png)

위의 그림의 과정을 순서적으로 나타내보자.

1. 왼쪽 사람의 돈 5000원을 뺀다.(UPDATE Account SET 왼쪽사람.돈=입금전-5000원;)
2. 뺀 돈을 오른쪽 사람에게 준다.(UPDATE Account SET 오른쪽사람.돈=입금전+5000원;)

위 1번과 2번 과정은 5000원을 입금하는 과정을 풀어 본 것이다.

이 두 과정 모두 원자적으로 처리되어야 한다. 너무 당연하다. 돈을 뺐는데 마침 서버가 터져버려? 그러면 당연히 왼쪽사람의 돈은 빠져나가지 않도록 다시 되돌려놔야한다.

이렇게 둘다 처리(커밋)되거나 둘다 처리(롤백)되지 않아야한다는 성질을 원자성 이라고 부른다.

### 일관성(Consistency)

일관성이라는 건 데이터베이스에서 정해놓은 규칙에 따라 처리가 수행되어야 한다는 것을 의미한다. 일관되게, 방법이나 태도 따위가 한결같아야 한다는 건데. 여기서 데이터베이스에서는 이 일관성을 제약조건, 데이터타입, 데이터의 길이 등의 규칙을 지켜야한다는 것을 의미한다. 다소 내용이 이해가 안될 수 있지만, 이 일관성은 정의 해둔 규칙을 잘 준수해야한다는 특징이라고 이해하면 좋을 것 같다.

예시를 들자면 이런 셈이다. 계좌에는 반드시 이름이 존재해야한다. 누구계좌인지 알아야하니깐. 그래서 계좌라는 정보에 우리는 이름이 반드시 존재해야해! 라는 규칙을 세웠다. 그런데 계좌의 주인 한명이 이름 운이 너무 없어서 개명을 하게되었다. 기존 김개똥에서 김황금으로. 그런데 개명 신청 절차가 너무 오래걸려서 일단 이름은 빼려고 했다. 그런데 은행에서는 계좌에 이름이 없으면 안돼요. 저희 규칙이에요. 무조건 지키셔야해요. 라는 답변을 받았다.

뭐 또 이런 예시도 있겠다. 계좌에 돈이 하나도 없는 마이너스 통장도 아닌 일반 입출금통장에서 돈을 빼려고한다. 곧 죽어도 돈을 출금시켜주면 안된다.

이런게 바로 일관성이다.

### 격리성(Isolation)

트랜잭션의 격리성이라는 것은 서로 다른 트랜잭션이 있으면 이 트랜잭션은 명확하게 독립적으로 동작되어야 한다는 것이다. 

오랜만에 와이프와 특별한 시간을 갖기 위해서 좋은 호텔을 예약하기로 했다. 때마침 다른 부부가 나랑 같은 생각을 했나보다. 그런데 방 예약 가능 잔여수가 1개밖에 안남았다. 손이 빠른 나는 엄청 빠르게 투타탁! 하며 예약을 끝마쳤다. 알고보니 다른 부부의 그 남편되시는 분도 한 스피드 하시는 모양이다 마찬가지로 투타탁! 하며 예약을 끝마쳤다.

이처럼 트랜잭션의 격리성은 트랜잭션이 격리되어있기 때문에 여러 문제가 야기될 수도 있다. 둘다 예약이 되어버리는 이 암담한 상황에 초래해버렸다.. 직원도 답답하다. 누굴줘야하나… 

때문에 데이터베이스에서는 이 격리성을 보장함과 동시에, 필요에 따라 이 격리 수준을 어떻게 보장할 것인지에 대한 정의를 할 수 있도록 격리 수준(Isolation Level)을 제공한다. 핀트가 엇나가면 안되니깐 그런게 있다 정도로만 이해하자… 위의 예시 같은 상황은 [InnoDB Row-level Lock](https://www.notion.so/InnoDB-Row-level-Lock-5ceb5d0a15124a929fc92646bc4d0b30) ← 이 내용을 읽으면 뭔가 더 알지도..

여하튼! 이 격리성은 서로다른 트랜잭션이 독립적으로 동작한다 격리되어 동작한다는 특징이다.

### 지속성(Durability)

이 지속성은 이미 수행된 트랜잭션 결과에 대해서 논한다. 트랜잭션을 수행했다. 그 트랜잭션에서 수행된 질의는 영구적으로 반영되어야한다. 그러니깐 계좌에서 돈을 빼서 입금을 했는데, 이 지속성이 보장이 안되면 돈이 그냥 증발해버릴 수도 있다.

데이터베이스에서는 이 지속성을 보장하기 위해서 로그를 남긴다. Undo Log, Redo Log. 자세한내용은 마찬가지로 핀트가 엇나가니깐.. 생략….

여하튼 입금이 완료되었으면 완료된 상태로 영구적으로 남아야하고, 만약 입금 과정에서 문제가 발생하더라도, 이전상태로 완벽하게 되돌아 갈 수 있어야한다는 의미이다. 어떻게보면 원자성 성질과 비슷하다고 생각될 수 있지만, 이 지속성은 반영한 처리 결과가 영구적이어야한다는 성질을 의미한다고 받아들이면 된다.