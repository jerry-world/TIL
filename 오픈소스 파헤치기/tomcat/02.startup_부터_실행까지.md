# 톰캣 동작 원리
본 페이지에서는 Tomcat의 동작과정을 자세히 다뤄보려고한다.

Tomcat의 동작원리를 소스코드 기반으로 이해하기 위해 최신 릴리즈 버전의 Git Repository를 Clone하였다.
```shell
git clone https://github.com/apache/tomcat.git
```

먼저 Tomcat 프로젝트의 최상위 구조를 살펴보자.
```
tomcat
  ㄴ bin/  - 바이너리 파일들이 존재한다. 외장 톰캣을 실행하기 위한 startup.sh이나 카타리나 동작을 위한 catalina.sh 등이 존재한다.
  ㄴ conf/ - 톰캣의 설정 파일들이 존재한다. 컨텍스트, 서버 포트, 카타리나 커스터마이징 등 다양한 설정이 가능하다.
  ㄴ java/ - 톰캣 애플리케이션 동작을 위한 소스코드가 존재한다. 톰캣에서 종속하는 Jakarta EE 의 일부사양과 톰캣 소스코드를 함께 포함하고 있다.
  ㄴ modules/ - 톰캣 동작의 외부 모듈이 존재한다. cxf, jdbc-pool, owb, stuffed
  ㄴ res/
  ㄴ test/ - 테스트 디렉터리이다.
  ㄴ webapps/ - 
  ㄴ build.xml
  
  이외에도 여러파일들이 존재하지만, 실제 Tomcat이 동작하는 코드와는 무관하다.
  가령, .github은 github Action동작을 위한 스크립트를 담은 디렉터리이다.
```

외장 톰캣을 다운로드했다는 전제로 실제로 톰캣을 구동했을 때의 동작원리를 살펴보겠다.

## 1. bin/startup.sh
톰캣 서비스는 바이너리 디렉터리(bin/)의 `startup.sh`로 시작한다. 

이 `startup.sh`은 `catalina.sh`스크립트를 실행시키기 위해, 대상 디렉터리에 `catalina.sh`이 있는지, 실행 권한이 존재하는지를 검증한다.

그리고 `catalina.sh` 을 호출하여, 작업을 위임한다.
```shell
PRG="$0"
PRGDIR=`dirname "$PRG"`
EXECUTABLE=catalina.sh
exec "$PRGDIR"/"$EXECUTABLE" start "$@"
```

## 2. bin/catalina.sh
`catalina.sh`은 톰캣을 실행시키기 위해, 필요한 필수 클래스패스를 정의하고, Java의 실행경로, 로깅/보안/모듈 등의 기본 정보들을 준비한다.

정확히는 `org.apache.catalina.startup.Bootstrap`에 명령인자를 전달하여, 카타리나 Bootstrap에게 작업을 위임하는 스크립트이다.

또한 사용자 환경 변수 정의에 따라, 제공하는 프로퍼티 키를 기반으로 카타리나 서버를 제어할 수 있다.

제공하는 내용은 대표적으로 CATALINA_HOME, CATALINA_BASE, CATALINA_OUT, JAVA_OPTS, JAVA_HOME 등이 있으며,
필수항목이 아닌 것들도 존재한다.

환경변수를 정의하고 싶다면 `bin/setenv.sh`(없으면 생성)에 대상 키 프로퍼티와 값을 정의해주면 된다.

### juli(Java Util Logging Implementation)
스크립트를 읽다보면 `tomcat-juli.jar`가 보이는데, 이 juli(Java Util Logging Implementation)는 톰캣 전역에서 발생되는 로그를 매니징하는 역할을 수행한다.

jakarta.logging 스펙에 기인한 라이브러리인데, 톰캣에서 여러 웹앱의 로깅을 독립적으로 관리할 수 있도록 도와준다.

다시 말해, 톰캣의 `Log Manager`이다. 자세한건, 톰캣 Log에 대해 다룰 때 다시 다루겠다.

### 명령분기

`catalina.sh` 명령 분기에 따라 사용자가 수행하고자 하는 액션을 동작한다.

`startup.sh`에 위임받아 동작한다면, `startup.sh`의 명령인자에 따라 start 명령을 수행한다.

`catalina.sh`에서의 명령 분기는 아래와 같다.
- run : foreground로 Bootstrap 시작
- start : Backgroupd로 Bootstrap 시작
- stop : 카타리나를 종료, 5초동안 프로세스가 끝나기를 기다린다. 만약 뒤의 명령인자로 숫자르 입력하면, 입력된 수 초만큼 기다리고 종료한다.
  - stop n : n 초 기다린 후 종료
  - stop -force : 5초 기다린 후 kill 커맨드를 사용하여 강제 프로세스 킬
  - stop n -force : n초 기다린후 kill 커맨드를 사용하여 강제 프로세스 킬
- jpda start : 카타리나 하위에서 JPDA 디버거를 시작
- debug : 카타리나 하위에서 디버거를 시작
- configtest : server.xml의 syntax를 검증한다.
- version : 버전을 검증한다.

---
#[요약]
```shell
java \
 "<CATALINA_LOGGING_CONFIG>" \
 -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager \
 $JAVA_OPTS $CATALINA_OPTS \
 -classpath "<bootstrap.jar>:<tomcat-juli.jar>" \
 -Dcatalina.base="<CATALINA_BASE>" \
 -Dcatalina.home="<CATALINA_HOME>" \
 -Djava.io.tmpdir="<CATALINA_TMPDIR>" \
 org.apache.catalina.startup.Bootstrap start \
 >> "<CATALINA_OUT>" 2>&1 &
```

[다음으로 (org.apache.catalina.startup.Bootstrap) > ](03.org.apache.catalina.startup.Bootstrap.java.md)