# 04. org.apache.catalina.startup.Catalina.java

Bootstrap으로부터 작업을 위임받아 실제 서비스를 구동하기 위해,

서버 인스턴스를 생성하고 서버를 시작한다.


- Catalina.load()

로드 메서드 에서는 server.xml을 파싱하고 이를 통해 서버 객체를 구성한다.

server.xml을 파싱하기 위해, Tomcat Util인 Digester클래스를 사용하며, XMLReader를 통해, `server.xml`에 설정된 정보를 파싱하고 이를 정의한다.

이때, Server 인스턴스가 생성되는데, 별다른 설정이 없으면 StandardServer 인스턴스를 생성한다.

또한, StandardServer의 services 배열에 Digester로부터 읽혀진 `server.xml`의 서비스들을 등록하는 작업도 함께 수행된다.

SetNext 룰에 따라, setServer(Server)를 호출하고, Catalina 인스턴스의 server 필드에 주입된다.

또한, initStreams 을 통해, `System.out` `System.err` 로 출력되는 콘솔 로그를 `catalina.out`으로 스트림되도록 초기화해준다.

그리고 끝으로 서버를 초기화하면서 서버를 실제로 동작시킨다.

StandardServer의 계층 구조는 아래와 같다.
```
Server (interface)
  ↑  implements
Lifecycle (interface)   - init(), start(), stop(), destroy() 시그니처를 선언
  ↑
LifecycleBase (abstract)   - init()/start()/stop()/destroy()의 “템플릿 메서드” 구현
  ↑
LifecycleMBeanBase (abstract)  - JMX 등록/해제 등 MBean 관련 부가 로직
  ↑
StandardServer               - initInternal()/startInternal()/... 오버라이드
```

```java
/**
 * Start a new server instance.
 */
public void load() {

    if (loaded) {
        return;
    }
    loaded = true;

    long t1 = System.nanoTime();

    // Before digester - it may be needed
    initNaming();

    // Parse main server.xml
    parseServerXml(true);
    Server s = getServer();
    if (s == null) {
        return;
    }

    getServer().setCatalina(this);
    Server server = new StandardServer(); //StandardServer 인스턴스 생성
    
    getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());
    getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());

    // Stream redirection
    initStreams();

    // Start the new server
    try {
        getServer().init();
    } catch (LifecycleException e) {
        if (throwOnInitFailure) {
            throw new Error(e);
        } else {
            log.error(sm.getString("catalina.initError"), e);
        }
    }

    if (log.isInfoEnabled()) {
        log.info(sm.getString("catalina.init",
                Long.toString(TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - t1))));
    }
}
```

[다음으로 (05. org.apache.catalina.core.StandardServer.java)](05.org.apache.catalina.core.StandardServer.java.md)