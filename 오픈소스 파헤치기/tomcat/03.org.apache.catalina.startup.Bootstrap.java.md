# 03. org.apache.catalina.startup.Bootstrap.java

Catalina가 시작되어 초기화 과정을 거치는 곳이다. 실제로 톰캣을 실행하면, 제일 먼저 만나는 지점이다.

이 Bootstrap 클래스 에서는 Catalina의 Base File과 Home File을 정의하고, 초기화 과정을 수행한뒤
전달받은 명령인자에 따라 서비스를 동작한다.

이 중 초기화 과정(`initClassLoaders()`)을 살펴보면 총 3가지의 로더를 초기화하는 과정을 거친다.

## 로더의 종류
로더는 크게 3가지로 나뉜다.
- 공통 로더(CommonLoader) : 톰캣 전역의 공용 라이브러리 영역이다. static 블록에서 선언된 CATALINA_HOME 디렉터리와 CATALINA_BASE 디렉터리의 lib 디렉터리 내 라이브러리들을 종속한다.
- 카타리나 로더(CatalinaLoader) : Tomcat 서버 엔진 구동을 위한 라이브러리를 로드한다. 아래는 카타리나 로더가 로드하는 가장 대표적인 라이브러리이다.
  - catalina.jar : Tomcat 서버의 핵심 엔진 라이브러리
  - coyote.jar : Connector 구현체(HTTP/1.1, AJP, NIO, APR 등 프로토콜 핸들링)
  - jasper.jar : JSP 엔진 (JSP -< 서블릿 변환 및 컴파일)
  - servlet-api.jar : Servlet API (javax.servlet / jakarta.servlet 인터페이스 정의)
  - jsp-api.jar : JSP API 인터페이스 정의
  - el-api.jar : JSP Expression Language API 정의
  - annotations-api.jar : @WebServlet, @WebFilter 등 Jakarta EE 애너테이션 정의
  - tomcat-juli.jar : 톰캣 로그 매니저 정의
  - 이 밖에도, 유틸성, 로그성, 보안 관련 등의 라이브러리들을 로드한다. 
- 공유 로더(Shared Loader) : 여러 웹 애플리케이션들이 함께 사용할 공통 라이브러리들을 로드한다. 각 웹앱 별로 로드하는 비용을 절감하여 공통적으로 공유할 수 있는 라이브러리들을 종속한다.
  - SharedLoader에 종속하고 싶은 라이브러리를 정의하면, 각 웹앱에서 개별 정의하지않더라도 공유 로더에 의해 로드할 수 있다.


- static 블록

Bootstrap클래스의 static 블록에서는 현재 작업 디렉터리를 기반으로, `CATALINA_HOME` 과 `CATALINA_BASE` 경로를 결정한다.
```java
static {
        // Will always be non-null
        String userDir = System.getProperty("user.dir");

        // Home first
        String home = System.getProperty(Constants.CATALINA_HOME_PROP);
        File homeFile = null;

        if (home != null) {
            File f = new File(home);
            try {
                homeFile = f.getCanonicalFile();
            } catch (IOException ioe) {
                homeFile = f.getAbsoluteFile();
            }
        }

        if (homeFile == null) {
            // First fall-back. See if current directory is a bin directory
            // in a normal Tomcat install
            File bootstrapJar = new File(userDir, "bootstrap.jar");

            if (bootstrapJar.exists()) {
                File f = new File(userDir, "..");
                try {
                    homeFile = f.getCanonicalFile();
                } catch (IOException ioe) {
                    homeFile = f.getAbsoluteFile();
                }
            }
        }

        if (homeFile == null) {
            // Second fall-back. Use current directory
            File f = new File(userDir);
            try {
                homeFile = f.getCanonicalFile();
            } catch (IOException ioe) {
                homeFile = f.getAbsoluteFile();
            }
        }

        catalinaHomeFile = homeFile;
        System.setProperty(Constants.CATALINA_HOME_PROP, catalinaHomeFile.getPath());

        // Then base
        String base = System.getProperty(Constants.CATALINA_BASE_PROP);
        if (base == null) {
            catalinaBaseFile = catalinaHomeFile;
        } else {
            File baseFile = new File(base);
            try {
                baseFile = baseFile.getCanonicalFile();
            } catch (IOException ioe) {
                baseFile = baseFile.getAbsoluteFile();
            }
            catalinaBaseFile = baseFile;
        }
        System.setProperty(Constants.CATALINA_BASE_PROP, catalinaBaseFile.getPath());
    }
```

- Bootstrap.init 메서드
톰캣의 3종 로더들을 초기화하고, Java 리플렉션을 통해, Catalina 의 setParentClassLoader 메서드를 호출하여, 클래스 로더를 정의한다.

또한, 카타리나 데몬을 정의한다.
```java
public void init() throws Exception {

        initClassLoaders();

        Thread.currentThread().setContextClassLoader(catalinaLoader);

        // Load our startup class and call its process() method
        if (log.isTraceEnabled()) {
            log.trace("Loading startup class");
        }
        Class<?> startupClass = catalinaLoader.loadClass("org.apache.catalina.startup.Catalina");
        Object startupInstance = startupClass.getConstructor().newInstance();

        // Set the shared extensions class loader
        if (log.isTraceEnabled()) {
            log.trace("Setting startup class properties");
        }
        String methodName = "setParentClassLoader";
        Class<?>[] paramTypes = new Class[1];
        paramTypes[0] = Class.forName("java.lang.ClassLoader");
        Object[] paramValues = new Object[1];
        paramValues[0] = sharedLoader;
        Method method = startupInstance.getClass().getMethod(methodName, paramTypes);
        method.invoke(startupInstance, paramValues);

        catalinaDaemon = startupInstance;
}
```

- main 메서드

main메서드에서는 실제 JVM이 Bootstramp.main(String[] args)를 호출하고, Bootstrap 인스턴스를 생성하여 초기화를 진행하며, 
전달된 명령인자를 통해 데몬을 수행한다.

start 명령인자의 경우, `org.apache.catalina.startup.Catalina` 클래스의 load메서드를 수행 후, start메서드를 수행하여 톰캣을 시작한다.

```java
public static void main(String[] args) {

    synchronized (daemonLock) {
        if (daemon == null) {
            // Don't set daemon until init() has completed
            Bootstrap bootstrap = new Bootstrap();
            try {
                bootstrap.init();
            } catch (Throwable t) {
                handleThrowable(t);
                log.error("Init exception", t);
                return;
            }
            daemon = bootstrap;
        } else {
            // When running as a service the call to stop will be on a new
            // thread so make sure the correct class loader is used to
            // prevent a range of class not found exceptions.
            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);
        }
    }

    try {
        String command = "start";
        if (args.length > 0) {
            command = args[args.length - 1];
        }

        switch (command) {
            case "startd":
                args[args.length - 1] = "start";
                daemon.load(args);
                daemon.start();
                break;
            case "stopd":
                args[args.length - 1] = "stop";
                daemon.stop();
                break;
            case "start":
                daemon.setAwait(true);
                daemon.load(args);
                daemon.start();
                if (null == daemon.getServer()) {
                    System.exit(1);
                }
                break;
            case "stop":
                daemon.stopServer(args);
                break;
            case "configtest":
                daemon.load(args);
                if (null == daemon.getServer()) {
                    System.exit(1);
                }
                System.exit(0);
                break;
            default:
                log.warn("Bootstrap: command \"" + command + "\" does not exist.");
                break;
        }
    } catch (Throwable t) {
        // Unwrap the Exception for clearer error reporting
        Throwable throwable = t;
        if (throwable instanceof InvocationTargetException && throwable.getCause() != null) {
            throwable = throwable.getCause();
        }
        handleThrowable(throwable);
        log.error("Error running command", throwable);
        System.exit(1);
    }
}
```

[다음으로 (04. org.apache.catalina.startup.Catalina.java) > ](04.org.apache.catalina.startup.Catalina.java.md)