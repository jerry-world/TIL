# 05. org.apache.catalina.core.StandardServer.java

Standard Server(Server의 구현체)는 톰캣의 서버 인스턴스를 대표하는 컴포넌트이다.

하위에 여러 개의 Service(Connector, Engine)으로 구성되어 있으며, 서버 전체의 생명주기를 관리한다.

Standard Server에서는 전역 Naming 리소스(JNDI)와 JMX 관리 인터페이스를 제공한다.

{Action)Internal 메서드 구성으로 LifecycleBase 로부터 작업을 위임받아 실제로 StandardServer의 작업을 수행하는 구체 구현체이다.

`Catalina` 클래스로부터 서버 초기화 와 서버 동작 요청을 호출받아 실제로 톰캣 서버를 구동하거나, 종료하는 작업을 실제 수행하게 된다.



---

Catalina 클래스에서 init을 호출하면 하위 상속 계층에따라 LifecycleBase의 init 메서드가 최초로 호출된다. 아래는 LifecycleBase에서

구현체인 StandardServer의 initInternal() 까지 호출되는 실제 로직을 정리한 내용을 나열한다.

```
StandardServer
↓
LifecycleMBeanBase
↓
LifecycleBase
```

### LifecycleBase
LifecycleBase 클래스는 생명주기를 정의하는 Lifecycle 인터페이스의 상속 클래스이다.

Lifecycle 인터페이스의 기본 구현체로서, Lifecycle#start()와 Lifecycle#stop() 메서드에 대한 상태 전이 규칙(state transition rules)을 구현한다.

- init()
  
init 메서드가 호출되면, 인스턴스의 현재 LifecycleState 상태 필드 정보를 바탕으로, 초기화 가능 여부를 확인하고, initInternal() 을 수행한뒤,
초기화됨 상태로 상태를 갱신한다.

```java
@Override
public final synchronized void init() throws LifecycleException {
    if (!state.equals(LifecycleState.NEW)) {
        invalidTransition(BEFORE_INIT_EVENT);
    }

    try {
        setStateInternal(LifecycleState.INITIALIZING, null, false);
        initInternal();
        setStateInternal(LifecycleState.INITIALIZED, null, false);
    } catch (Throwable t) {
        handleSubClassException(t, "lifecycleBase.initFail", toString());
    }
}

protected abstract void initInternal() throws LifecycleException;
```

StandardService가 LifecycleBase로부터 initInternal 메서드를 호출 받아, 실제 StandardServer의 초기화 작업을 수행하는 단계이다.

먼저 부모(LifecycleMBeanBase)의 initInternal을 호출하여, Jmx에 등록될 수 있도록 Tomcat의 Registry를 사용하여 MBeanServer에 등록작업을 수행한다.

StandardServer 에서 StringCache, MBeanFactory를 MBeanServer에 등록하는 작업도 함께 수행된다.

이후, globalNamingResources와 서비스들을 모두 초기화한다.(MBeanServer는 JMX 파트에서 자세하게 다룰 예정)

여기서는 StandardServer에 등록된 Service 들을 모두 초기화하는 과정이 가장 중요한 핵심이라할 수 있다.

(Service는 Tomcat 초기화 과정에서 Digester에 의해 server.xml이 파싱될 때, 등록되는 Service를 의미한다.)

```java
public final class StandardServer extends LifecycleMBeanBase implements Server {
    /**
     * 중간 생략
     */
    @Override
    protected void initInternal() throws LifecycleException {

        super.initInternal();

        // Register global String cache
        // Note although the cache is global, if there are multiple Servers
        // present in the JVM (may happen when embedding) then the same cache
        // will be registered under multiple names
        onameStringCache = register(new StringCache(), "type=StringCache");

        // Register the MBeanFactory
        MBeanFactory factory = new MBeanFactory();
        factory.setContainer(this);
        onameMBeanFactory = register(factory, "type=MBeanFactory");

        // Register the naming resources
        globalNamingResources.init();

        // Initialize our defined Services
        for (Service service : findServices()) {
            service.init();
        }
    }
}
```

- initInternal() in LifecycleMBeanBase.java

```java
@Override
public abstract class LifecycleMBeanBase extends LifecycleBase implements JmxEnabled {
    /**
     * 중간 생략
     */
    protected void initInternal() throws LifecycleException {
        // If oname is not null then registration has already happened via
        // preRegister().
        if (oname == null) {
            oname = register(this, getObjectNameKeyProperties());
        }
    }
}
```

[다음으로(06. 06. Digester에 의한 Service 등록) > ](06.Digester에_의한_Service_등록.md)